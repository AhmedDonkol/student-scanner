<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Barcode Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1976d2" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Basic styles -->
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    header {
      background: #1976d2;
      color: white;
      padding: 12px 16px;
      text-align: center;
      font-size: 18px;
    }
    main {
      padding: 12px 16px 40px;
      max-width: 700px;
      margin: 0 auto;
    }
    button {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      margin: 4px 4px 8px 0;
      cursor: pointer;
    }
    button.primary {
      background: #1976d2;
      color: white;
    }
    button.secondary {
      background: #e0e0e0;
    }
    button.danger {
      background: #d32f2f;
      color: white;
    }
    video {
      width: 100%;
      max-height: 320px;
      background: black;
      border-radius: 10px;
      margin-top: 8px;
    }
    .section-title {
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    ul {
      list-style: none;
      padding-left: 0;
      margin-top: 0;
    }
    li {
      background: white;
      border-radius: 6px;
      padding: 8px 10px;
      margin: 4px 0;
      font-size: 14px;
      word-wrap: break-word;
    }
    .code {
      font-weight: 600;
    }
    .time {
      font-size: 12px;
      color: #777;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .empty {
      font-size: 13px;
      color: #999;
      margin-top: 6px;
    }
    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e3f2fd;
      color: #0d47a1;
      font-size: 12px;
      margin-top: 6px;
    }
    .pill.duplicate {
      background: #ffebee;
      color: #b71c1c;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }
    .field {
      flex: 1 1 140px;
      min-width: 140px;
    }
    .field label {
      display: block;
      font-size: 12px;
      color: #555;
      margin-bottom: 2px;
    }
    .field input, .field select {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: white;
    }
    .small-note {
      font-size: 11px;
      color: #777;
      margin-top: 4px;
    }
    #currentSessionLabel {
      font-size: 12px;
      color: #444;
      margin-top: 6px;
    }
  </style>

  <!-- ZXing library from CDN -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>
  <header>
    Student Barcode Scanner
  </header>

  <main>
    <!-- Session info card -->
    <div class="card">
      <div class="section-title">Session details</div>

      <div class="field-row">
        <div class="field">
          <label for="sessionSelect">Open existing session</label>
          <select id="sessionSelect">
            <option value="">-- No session selected --</option>
          </select>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="subjectInput">Subject</label>
          <input id="subjectInput" type="text" placeholder="e.g. Math, English" />
        </div>
        <div class="field">
          <label for="dateInput">Date</label>
          <input id="dateInput" type="date" />
        </div>
        <div class="field">
          <label for="sessionInput">Session / Time</label>
          <input id="sessionInput" type="text" placeholder="e.g. Morning, Period 1" />
        </div>
      </div>

      <button id="saveSessionBtn" class="secondary">
        Create / Update session &amp; select
      </button>

      <p id="currentSessionLabel"></p>
      <div class="small-note">
        1) To start a new session: fill Subject / Date / Session, click "Create / Update".<br>
        2) To open an old session: choose it from "Open existing session".
      </div>
    </div>

    <!-- Scanner controls -->
    <div class="card">
      <div class="section-title">Scanner controls</div>

      <div class="field" style="margin-bottom: 8px;">
        <label for="cameraSelect">Camera</label>
        <select id="cameraSelect">
          <option value="">Loading cameras...</option>
        </select>
      </div>

      <div>
        <button id="startBtn" class="primary">Start scanning</button>
        <button id="stopBtn" class="secondary">Stop</button>
      </div>

      <video id="video" muted playsinline></video>
      <p class="hint">
        If the camera doesn't start, make sure the browser has camera permission enabled.
      </p>

      <div class="pill" id="lastScanPill" style="display:none;"></div>
    </div>

    <!-- Manual entry -->
    <div class="card">
      <div class="section-title">Manual entry</div>
      <div class="field-row">
        <div class="field" style="flex: 2;">
          <input id="manualInput" type="text" placeholder="Enter barcode manually..." />
        </div>
        <div style="display: flex; align-items: flex-end;">
          <button id="manualAddBtn" class="primary">Add</button>
        </div>
      </div>
      <div class="small-note">Use this if scanning doesn't work or for quick entry.</div>
    </div>

    <div class="section-title">Saved scans (current session)</div>

    <!-- Statistics -->
    <div id="statsBar" class="card" style="display:none; font-size: 13px; padding: 8px 12px;">
      <strong>Statistics:</strong> <span id="statsText"></span>
    </div>

    <!-- Search -->
    <div style="margin-bottom: 8px;">
      <input id="searchInput" type="text" placeholder="Search scans..." style="width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;" />
    </div>

    <div>
      <button id="downloadCsvBtn" class="secondary">Download CSV</button>
      <button id="downloadJsonBtn" class="secondary">Download JSON</button>
      <button id="downloadAllBtn" class="secondary">Export all sessions</button>
      <button id="clearSessionBtn" class="danger">Delete this session</button>
      <button id="clearBtn" class="danger">Clear all sessions</button>
    </div>

    <div id="undoBar" style="display:none; background: #333; color: white; padding: 8px 12px; border-radius: 6px; margin: 8px 0; font-size: 13px;">
      <span id="undoText"></span>
      <button id="undoBtn" style="background: #4CAF50; color: white; padding: 4px 12px; margin-left: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Undo</button>
    </div>

    <ul id="list"></ul>
    <p id="emptyMsg" class="empty" style="display:none;">No scans for this session yet.</p>
  </main>

  <script>
    // Sessions and records:
    // sessions: [{ id, subject, date, sessionTime }]
    // recordsBySession: { [id]: [{ code, time }] }

    const SESSIONS_KEY = 'scanner_sessions_v1';
    const RECORDS_KEY  = 'scanner_records_v1';

    const codeReader = new ZXing.BrowserMultiFormatReader();

    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const clearBtn = document.getElementById('clearBtn');
    const clearSessionBtn = document.getElementById('clearSessionBtn');
    const lastScanPill = document.getElementById('lastScanPill');
    const list = document.getElementById('list');
    const emptyMsg = document.getElementById('emptyMsg');
    const cameraSelect = document.getElementById('cameraSelect');
    const manualInput = document.getElementById('manualInput');
    const manualAddBtn = document.getElementById('manualAddBtn');
    const searchInput = document.getElementById('searchInput');
    const statsBar = document.getElementById('statsBar');
    const statsText = document.getElementById('statsText');
    const undoBar = document.getElementById('undoBar');
    const undoText = document.getElementById('undoText');
    const undoBtn = document.getElementById('undoBtn');

    const subjectInput = document.getElementById('subjectInput');
    const dateInput = document.getElementById('dateInput');
    const sessionInput = document.getElementById('sessionInput');
    const saveSessionBtn = document.getElementById('saveSessionBtn');
    const sessionSelect = document.getElementById('sessionSelect');
    const currentSessionLabel = document.getElementById('currentSessionLabel');

    let sessions = [];
    let recordsBySession = {};
    let currentSessionId = null;
    let scanning = false;
    let currentDeviceId = null;
    let availableCameras = [];
    let undoStack = [];
    let searchQuery = '';

    // Debounce: avoid repeated reading of same barcode every frame
    let lastScannedCode = null;
    let lastScannedAt = 0; // timestamp in ms

    // Audio feedback
    const beepSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCiJ1vLVgjAGHm7A7+OZRA4RWqzp8qVcFhE7lunxvnMgBSB/zfLZ...');

    // ---------- Utilities ----------
    function todayISODate() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function makeSessionId(subject, date, sessionTime) {
      return `${subject}||${date}||${sessionTime}`;
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      const dateStr = date.toLocaleDateString();
      const timeStr = date.toLocaleTimeString();
      return `${dateStr} ${timeStr}`;
    }

    function playBeep() {
      try {
        beepSound.currentTime = 0;
        beepSound.play().catch(e => console.log('Audio play failed:', e));
      } catch (e) {
        console.log('Audio error:', e);
      }
    }

    async function loadCameras() {
      try {
        availableCameras = await codeReader.listVideoInputDevices();
        cameraSelect.innerHTML = '';

        if (availableCameras.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No cameras found';
          cameraSelect.appendChild(opt);
          return;
        }

        availableCameras.forEach((device, index) => {
          const opt = document.createElement('option');
          opt.value = device.deviceId;
          opt.textContent = device.label || `Camera ${index + 1}`;
          cameraSelect.appendChild(opt);
        });

        if (availableCameras.length > 0) {
          currentDeviceId = availableCameras[availableCameras.length - 1].deviceId;
          cameraSelect.value = currentDeviceId;
        }
      } catch (e) {
        console.error('Error loading cameras:', e);
        cameraSelect.innerHTML = '<option value="">Error loading cameras</option>';
      }
    }

    // ---------- Load & save ----------
    function loadAll() {
      try {
        sessions = JSON.parse(localStorage.getItem(SESSIONS_KEY) || '[]');
      } catch {
        sessions = [];
      }
      try {
        recordsBySession = JSON.parse(localStorage.getItem(RECORDS_KEY) || '{}');
      } catch {
        recordsBySession = {};
      }

      if (sessions.length > 0 && !currentSessionId) {
        currentSessionId = sessions[sessions.length - 1].id;
      }
    }

    function saveSessions() {
      localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions));
    }

    function saveRecords() {
      localStorage.setItem(RECORDS_KEY, JSON.stringify(recordsBySession));
    }

    // ---------- Session helpers ----------
    function getSessionById(id) {
      return sessions.find(s => s.id === id) || null;
    }

    function getCurrentSessionMeta() {
      if (!currentSessionId) return null;
      return getSessionById(currentSessionId);
    }

    function getCurrentRecords() {
      if (!currentSessionId) return [];
      return recordsBySession[currentSessionId] || [];
    }

    function ensureRecordsArrayForSession(id) {
      if (!recordsBySession[id]) {
        recordsBySession[id] = [];
      }
    }

    function refreshSessionSelect() {
      sessionSelect.innerHTML = '';

      const optNone = document.createElement('option');
      optNone.value = '';
      optNone.textContent = '-- No session selected --';
      sessionSelect.appendChild(optNone);

      sessions.forEach(session => {
        const opt = document.createElement('option');
        opt.value = session.id;
        const label = `${session.date || 'No date'} - ${session.subject || 'No subject'} (${session.sessionTime || 'Session'})`;
        opt.textContent = label;
        if (session.id === currentSessionId) {
          opt.selected = true;
        }
        sessionSelect.appendChild(opt);
      });
    }

    function updateSessionInputsFromCurrent() {
      const session = getCurrentSessionMeta();
      if (!session) {
        if (!dateInput.value) dateInput.value = todayISODate();
        subjectInput.value = subjectInput.value || '';
        sessionInput.value = sessionInput.value || '';
        return;
      }
      subjectInput.value = session.subject || '';
      dateInput.value = session.date || todayISODate();
      sessionInput.value = session.sessionTime || '';
    }

    function updateCurrentSessionLabel() {
      const session = getCurrentSessionMeta();
      if (!session) {
        currentSessionLabel.textContent = 'Current session: none selected.';
      } else {
        currentSessionLabel.textContent =
          `Current session: ${session.date || '-'} – ${session.subject || '-'} (${session.sessionTime || 'Session'})`;
      }
    }

    function createOrUpdateSession() {
      const subject = subjectInput.value.trim();
      let date = dateInput.value;
      const sessionTime = sessionInput.value.trim();

      if (!subject) {
        alert('Please enter a subject.');
        return;
      }
      if (!date) {
        date = todayISODate();
        dateInput.value = date;
      }

      const id = makeSessionId(subject, date, sessionTime);
      let session = getSessionById(id);

      if (!session) {
        session = { id, subject, date, sessionTime };
        sessions.push(session);
      } else {
        session.subject = subject;
        session.date = date;
        session.sessionTime = sessionTime;
      }

      currentSessionId = id;
      ensureRecordsArrayForSession(id);
      saveSessions();
      saveRecords();
      refreshSessionSelect();
      updateCurrentSessionLabel();
      renderList();
      alert('Session selected and saved.');
    }

    function handleSessionSelectChange() {
      const id = sessionSelect.value || null;
      currentSessionId = id;
      updateSessionInputsFromCurrent();
      updateCurrentSessionLabel();
      renderList();
      lastScanPill.style.display = 'none';
    }

    // ---------- Records ----------
    function addRecordToCurrentSession(code) {
      const session = getCurrentSessionMeta();
      if (!session) {
        alert('Please create or select a session first.');
        return;
      }

      ensureRecordsArrayForSession(session.id);
      const records = getCurrentRecords();
      const exists = records.some(r => r.code === code);

      if (exists) {
        showDuplicateScan(code);
        return;
      }

      const now = new Date();
      records.push({
        code: String(code),
        time: now.toISOString()
      });
      recordsBySession[session.id] = records;
      saveRecords();
      renderList();
      showLastScan(code);
      playBeep();
      updateStats();
    }

    function deleteRecord(sessionId, code) {
      const records = recordsBySession[sessionId] || [];
      const index = records.findIndex(r => r.code === code);
      if (index === -1) return;

      const deleted = records.splice(index, 1)[0];
      recordsBySession[sessionId] = records;
      saveRecords();

      undoStack.push({
        action: 'deleteRecord',
        sessionId: sessionId,
        record: deleted,
        index: index
      });
      showUndo(`Deleted scan: ${code}`);
      renderList();
      updateStats();
    }

    function editRecord(sessionId, oldCode, newCode) {
      const records = recordsBySession[sessionId] || [];
      const record = records.find(r => r.code === oldCode);
      if (!record) return;

      const exists = records.some(r => r.code === newCode && r.code !== oldCode);
      if (exists) {
        alert('This code already exists in the session.');
        return;
      }

      undoStack.push({
        action: 'editRecord',
        sessionId: sessionId,
        oldCode: oldCode,
        newCode: newCode
      });

      record.code = newCode;
      saveRecords();
      showUndo(`Edited: ${oldCode} → ${newCode}`);
      renderList();
    }

    function deleteSession(sessionId) {
      if (!confirm('Delete this session and all its scans?')) return;

      const sessionIndex = sessions.findIndex(s => s.id === sessionId);
      if (sessionIndex === -1) return;

      const deletedSession = sessions.splice(sessionIndex, 1)[0];
      const deletedRecords = recordsBySession[sessionId] || [];
      delete recordsBySession[sessionId];

      undoStack.push({
        action: 'deleteSession',
        session: deletedSession,
        records: deletedRecords,
        index: sessionIndex
      });

      if (currentSessionId === sessionId) {
        currentSessionId = sessions.length > 0 ? sessions[0].id : null;
      }

      saveSessions();
      saveRecords();
      refreshSessionSelect();
      updateSessionInputsFromCurrent();
      updateCurrentSessionLabel();
      renderList();
      showUndo(`Deleted session: ${deletedSession.subject}`);
    }

    function updateStats() {
      const records = getCurrentRecords();
      if (records.length === 0) {
        statsBar.style.display = 'none';
        return;
      }

      statsBar.style.display = 'block';
      const times = records.map(r => new Date(r.time).getTime());
      const first = new Date(Math.min(...times));
      const last = new Date(Math.max(...times));

      statsText.textContent = `${records.length} scan${records.length !== 1 ? 's' : ''} | First: ${first.toLocaleTimeString()} | Last: ${last.toLocaleTimeString()}`;
    }

    function clearAllSessionsAndRecords() {
      if (!confirm('This will delete ALL sessions and scans on this device. Continue?')) {
        return;
      }
      sessions = [];
      recordsBySession = {};
      currentSessionId = null;
      saveSessions();
      saveRecords();
      refreshSessionSelect();
      updateCurrentSessionLabel();
      renderList();
      lastScanPill.style.display = 'none';
      updateStats();
    }

    function showUndo(message) {
      undoText.textContent = message;
      undoBar.style.display = 'block';
      setTimeout(() => {
        undoBar.style.display = 'none';
      }, 10000);
    }

    function performUndo() {
      if (undoStack.length === 0) return;

      const action = undoStack.pop();

      if (action.action === 'deleteRecord') {
        const records = recordsBySession[action.sessionId] || [];
        records.splice(action.index, 0, action.record);
        recordsBySession[action.sessionId] = records;
        saveRecords();
      } else if (action.action === 'editRecord') {
        const records = recordsBySession[action.sessionId] || [];
        const record = records.find(r => r.code === action.newCode);
        if (record) {
          record.code = action.oldCode;
          saveRecords();
        }
      } else if (action.action === 'deleteSession') {
        sessions.splice(action.index, 0, action.session);
        recordsBySession[action.session.id] = action.records;
        saveSessions();
        saveRecords();
        refreshSessionSelect();
      }

      undoBar.style.display = 'none';
      renderList();
      updateStats();
      updateCurrentSessionLabel();
    }

    function renderList() {
      list.innerHTML = '';

      const session = getCurrentSessionMeta();
      if (!session) {
        emptyMsg.textContent = 'No session selected.';
        emptyMsg.style.display = 'block';
        statsBar.style.display = 'none';
        return;
      }

      let records = getCurrentRecords().slice().sort((a, b) =>
        a.code.localeCompare(b.code)
      );

      if (searchQuery.trim()) {
        const query = searchQuery.toLowerCase();
        records = records.filter(r => r.code.toLowerCase().includes(query));
      }

      if (records.length === 0) {
        emptyMsg.textContent = searchQuery ? 'No matching scans found.' : 'No scans for this session yet.';
        emptyMsg.style.display = 'block';
        if (!searchQuery) statsBar.style.display = 'none';
        return;
      } else {
        emptyMsg.style.display = 'none';
      }

      records.forEach((r, index) => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';

        const contentDiv = document.createElement('div');
        contentDiv.style.flex = '1';

        const codeDiv = document.createElement('div');
        codeDiv.className = 'code';
        codeDiv.textContent = `${index + 1}. ${r.code}`;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'time';
        timeDiv.textContent = formatTime(r.time);

        contentDiv.appendChild(codeDiv);
        contentDiv.appendChild(timeDiv);

        const actionsDiv = document.createElement('div');
        actionsDiv.style.display = 'flex';
        actionsDiv.style.gap = '4px';

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.className = 'secondary';
        editBtn.style.fontSize = '11px';
        editBtn.style.padding = '4px 8px';
        editBtn.style.margin = '0';
        editBtn.onclick = () => {
          const newCode = prompt('Edit barcode:', r.code);
          if (newCode && newCode.trim() && newCode !== r.code) {
            editRecord(session.id, r.code, newCode.trim());
          }
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'danger';
        deleteBtn.style.fontSize = '11px';
        deleteBtn.style.padding = '4px 8px';
        deleteBtn.style.margin = '0';
        deleteBtn.onclick = () => {
          deleteRecord(session.id, r.code);
        };

        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);

        li.appendChild(contentDiv);
        li.appendChild(actionsDiv);
        list.appendChild(li);
      });
    }

    function showLastScan(code) {
      lastScanPill.classList.remove('duplicate');
      lastScanPill.textContent = 'Last scan: ' + code;
      lastScanPill.style.display = 'inline-block';
    }

    function showDuplicateScan(code) {
      lastScanPill.classList.add('duplicate');
      lastScanPill.textContent = 'Already scanned this session: ' + code;
      lastScanPill.style.display = 'inline-block';
    }

    // ---------- Scanner with debounce ----------
    async function startScan() {
      if (scanning) return;

      const session = getCurrentSessionMeta();
      if (!session) {
        alert('Please create or select a session first.');
        return;
      }

      scanning = true;

      try {
        if (!currentDeviceId) {
          const devices = await codeReader.listVideoInputDevices();
          if (!devices || devices.length === 0) {
            alert('No camera found');
            scanning = false;
            return;
          }
          currentDeviceId = devices[devices.length - 1].deviceId;
        }

        await codeReader.decodeFromVideoDevice(currentDeviceId, video, (result, err) => {
          if (result) {
            const text = result.getText();
            const now = Date.now();

            if (
              text &&
              (
                text !== lastScannedCode ||
                now - lastScannedAt > 1500  // 1.5 seconds
              )
            ) {
              lastScannedCode = text;
              lastScannedAt = now;
              addRecordToCurrentSession(text);
            }
          }
        });
      } catch (e) {
        console.error(e);
        alert('Error starting camera: ' + e);
        scanning = false;
      }
    }

    function stopScan() {
      try {
        codeReader.reset();
      } catch (e) {
        console.error('Error stopping scanner', e);
      }
      scanning = false;
    }

    // ---------- Export functions ----------
    function downloadCSV() {
      const session = getCurrentSessionMeta();
      if (!session) {
        alert('Please select a session first.');
        return;
      }

      const records = getCurrentRecords();
      if (records.length === 0) {
        alert('No records to export for this session.');
        return;
      }

      let csv = 'Code,Time,Subject,Date,Session\n';

      records.forEach(r => {
        const code = String(r.code).replace(/"/g, '""');
        const time = String(r.time).replace(/"/g, '""');
        const subject = String(session.subject || '').replace(/"/g, '""');
        const date = String(session.date || '').replace(/"/g, '""');
        const sessionTime = String(session.sessionTime || '').replace(/"/g, '""');

        csv += `"${code}","${time}","${subject}","${date}","${sessionTime}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'students_' + (session.date || 'session') + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadJSON() {
      const session = getCurrentSessionMeta();
      if (!session) {
        alert('Please select a session first.');
        return;
      }

      const records = getCurrentRecords();
      if (records.length === 0) {
        alert('No records to export for this session.');
        return;
      }

      const data = {
        session: session,
        records: records,
        exportDate: new Date().toISOString()
      };

      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'students_' + (session.date || 'session') + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadAllSessions() {
      if (sessions.length === 0) {
        alert('No sessions to export.');
        return;
      }

      const data = {
        sessions: sessions,
        recordsBySession: recordsBySession,
        exportDate: new Date().toISOString()
      };

      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'all_sessions_' + todayISODate() + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ---------- Event wiring ----------
    startBtn.addEventListener('click', startScan);
    stopBtn.addEventListener('click', stopScan);
    downloadCsvBtn.addEventListener('click', downloadCSV);
    downloadJsonBtn.addEventListener('click', downloadJSON);
    downloadAllBtn.addEventListener('click', downloadAllSessions);
    clearBtn.addEventListener('click', clearAllSessionsAndRecords);
    clearSessionBtn.addEventListener('click', () => {
      if (currentSessionId) {
        deleteSession(currentSessionId);
      }
    });
    saveSessionBtn.addEventListener('click', createOrUpdateSession);
    sessionSelect.addEventListener('change', handleSessionSelectChange);
    cameraSelect.addEventListener('change', (e) => {
      currentDeviceId = e.target.value;
      if (scanning) {
        stopScan();
        setTimeout(() => startScan(), 100);
      }
    });
    manualAddBtn.addEventListener('click', () => {
      const code = manualInput.value.trim();
      if (code) {
        addRecordToCurrentSession(code);
        manualInput.value = '';
      }
    });
    manualInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const code = manualInput.value.trim();
        if (code) {
          addRecordToCurrentSession(code);
          manualInput.value = '';
        }
      }
    });
    searchInput.addEventListener('input', (e) => {
      searchQuery = e.target.value;
      renderList();
    });
    undoBtn.addEventListener('click', performUndo);

    // ---------- Init ----------
    function init() {
      loadAll();
      if (!dateInput.value) dateInput.value = todayISODate();
      refreshSessionSelect();
      updateSessionInputsFromCurrent();
      updateCurrentSessionLabel();
      renderList();
      updateStats();
      loadCameras();
    }

    init();

    // ---------- Service worker ----------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .catch(err => console.error('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
